<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mt.order.common.dao.QuoteMapper">
  <resultMap id="BaseResultMap" type="com.mt.order.common.model.Quote">
    <id column="id" jdbcType="BIGINT" property="id" />
    <result column="version" jdbcType="INTEGER" property="version" />
    <result column="company_id" jdbcType="INTEGER" property="companyId" />
    <result column="company_name" jdbcType="VARCHAR" property="companyName" />
    <result column="dep_id" jdbcType="INTEGER" property="depId" />
    <result column="dep_name" jdbcType="VARCHAR" property="depName" />
    <result column="quote_no" jdbcType="VARCHAR" property="quoteNo" />
    <result column="cst_company_id" jdbcType="INTEGER" property="cstCompanyId" />
    <result column="cst_name" jdbcType="VARCHAR" property="cstName" />
    <result column="phone" jdbcType="VARCHAR" property="phone" />
    <result column="fax" jdbcType="VARCHAR" property="fax" />
    <result column="email" jdbcType="VARCHAR" property="email" />
    <result column="connect_man" jdbcType="VARCHAR" property="connectMan" />
    <result column="salesman" jdbcType="BIGINT" property="salesman" />
    <result column="salesman_name" jdbcType="VARCHAR" property="salesmanName" />
    <result column="handler" jdbcType="BIGINT" property="handler" />
    <result column="handler_name" jdbcType="VARCHAR" property="handlerName" />
    <result column="quote_date" jdbcType="TIMESTAMP" property="quoteDate" />
    <result column="avail_days" jdbcType="VARCHAR" property="availDays" />
    <result column="prod_name" jdbcType="VARCHAR" property="prodName" />
    <result column="invoice_type" jdbcType="TINYINT" property="invoiceType" />
    <result column="invoice_type_name" jdbcType="VARCHAR" property="invoiceTypeName" />
    <result column="tax_ratio" jdbcType="DECIMAL" property="taxRatio" />
    <result column="quote_price" jdbcType="DECIMAL" property="quotePrice" />
    <result column="quote_price_local" jdbcType="DECIMAL" property="quotePriceLocal" />
    <result column="coin" jdbcType="VARCHAR" property="coin" />
    <result column="coin_local" jdbcType="VARCHAR" property="coinLocal" />
    <result column="delivery_place" jdbcType="VARCHAR" property="deliveryPlace" />
    <result column="approve_step" jdbcType="VARCHAR" property="approveStep" />
    <result column="approve_sugg" jdbcType="VARCHAR" property="approveSugg" />
    <result column="status" jdbcType="TINYINT" property="status" />
    <result column="is_active" jdbcType="BIT" property="isActive" />
    <result column="created_at" jdbcType="TIMESTAMP" property="createdAt" />
    <result column="updated_at" jdbcType="TIMESTAMP" property="updatedAt" />
  </resultMap>
  <sql id="Base_Column_List">
    id, version, company_id, company_name, dep_id, dep_name, quote_no, cst_company_id,
    cst_name, phone, fax, email, connect_man, salesman, salesman_name, handler, handler_name,
    quote_date, avail_days, prod_name, invoice_type, invoice_type_name, tax_ratio, quote_price,
    quote_price_local, coin, coin_local, delivery_place, approve_step, approve_sugg,
    status, is_active, created_at, updated_at
  </sql>
  <select id="selectByPrimaryKey" parameterType="java.lang.Long" resultMap="BaseResultMap">
    select
    <include refid="Base_Column_List" />
    from quote
    where id = #{id,jdbcType=BIGINT}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Long">
    delete from quote
    where id = #{id,jdbcType=BIGINT}
  </delete>
  <insert id="insert" parameterType="com.mt.order.common.model.Quote">
    insert into quote (id, version, company_id,
    company_name, dep_id, dep_name,
    quote_no, cst_company_id, cst_name,
    phone, fax, email,
    connect_man, salesman, salesman_name,
    handler, handler_name, quote_date,
    avail_days, prod_name, invoice_type,
    invoice_type_name, tax_ratio, quote_price,
    quote_price_local, coin, coin_local,
    delivery_place, approve_step, approve_sugg,
    status, is_active, created_at,
    updated_at)
    values (#{id,jdbcType=BIGINT}, #{version,jdbcType=INTEGER}, #{companyId,jdbcType=INTEGER},
    #{companyName,jdbcType=VARCHAR}, #{depId,jdbcType=INTEGER}, #{depName,jdbcType=VARCHAR},
    #{quoteNo,jdbcType=VARCHAR}, #{cstCompanyId,jdbcType=INTEGER}, #{cstName,jdbcType=VARCHAR},
    #{phone,jdbcType=VARCHAR}, #{fax,jdbcType=VARCHAR}, #{email,jdbcType=VARCHAR},
    #{connectMan,jdbcType=VARCHAR}, #{salesman,jdbcType=BIGINT}, #{salesmanName,jdbcType=VARCHAR},
    #{handler,jdbcType=BIGINT}, #{handlerName,jdbcType=VARCHAR}, #{quoteDate,jdbcType=TIMESTAMP},
    #{availDays,jdbcType=VARCHAR}, #{prodName,jdbcType=VARCHAR}, #{invoiceType,jdbcType=TINYINT},
    #{invoiceTypeName,jdbcType=VARCHAR}, #{taxRatio,jdbcType=DECIMAL}, #{quotePrice,jdbcType=DECIMAL},
    #{quotePriceLocal,jdbcType=DECIMAL}, #{coin,jdbcType=VARCHAR}, #{coinLocal,jdbcType=VARCHAR},
    #{deliveryPlace,jdbcType=VARCHAR}, #{approveStep,jdbcType=VARCHAR}, #{approveSugg,jdbcType=VARCHAR},
    #{status,jdbcType=TINYINT}, #{isActive,jdbcType=BIT}, #{createdAt,jdbcType=TIMESTAMP},
    #{updatedAt,jdbcType=TIMESTAMP})
  </insert>
  <insert id="insertSelective" parameterType="com.mt.order.common.model.Quote">
    insert into quote
    <trim prefix="(" suffix=")" suffixOverrides=",">
      <if test="id != null">
        id,
      </if>
      <if test="version != null">
        version,
      </if>
      <if test="companyId != null">
        company_id,
      </if>
      <if test="companyName != null">
        company_name,
      </if>
      <if test="depId != null">
        dep_id,
      </if>
      <if test="depName != null">
        dep_name,
      </if>
      <if test="quoteNo != null">
        quote_no,
      </if>
      <if test="cstCompanyId != null">
        cst_company_id,
      </if>
      <if test="cstName != null">
        cst_name,
      </if>
      <if test="phone != null">
        phone,
      </if>
      <if test="fax != null">
        fax,
      </if>
      <if test="email != null">
        email,
      </if>
      <if test="connectMan != null">
        connect_man,
      </if>
      <if test="salesman != null">
        salesman,
      </if>
      <if test="salesmanName != null">
        salesman_name,
      </if>
      <if test="handler != null">
        handler,
      </if>
      <if test="handlerName != null">
        handler_name,
      </if>
      <if test="quoteDate != null">
        quote_date,
      </if>
      <if test="availDays != null">
        avail_days,
      </if>
      <if test="prodName != null">
        prod_name,
      </if>
      <if test="invoiceType != null">
        invoice_type,
      </if>
      <if test="invoiceTypeName != null">
        invoice_type_name,
      </if>
      <if test="taxRatio != null">
        tax_ratio,
      </if>
      <if test="quotePrice != null">
        quote_price,
      </if>
      <if test="quotePriceLocal != null">
        quote_price_local,
      </if>
      <if test="coin != null">
        coin,
      </if>
      <if test="coinLocal != null">
        coin_local,
      </if>
      <if test="deliveryPlace != null">
        delivery_place,
      </if>
      <if test="approveStep != null">
        approve_step,
      </if>
      <if test="approveSugg != null">
        approve_sugg,
      </if>
      <if test="status != null">
        status,
      </if>
      <if test="isActive != null">
        is_active,
      </if>
      <if test="createdAt != null">
        created_at,
      </if>
      <if test="updatedAt != null">
        updated_at,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      <if test="id != null">
        #{id,jdbcType=BIGINT},
      </if>
      <if test="version != null">
        #{version,jdbcType=INTEGER},
      </if>
      <if test="companyId != null">
        #{companyId,jdbcType=INTEGER},
      </if>
      <if test="companyName != null">
        #{companyName,jdbcType=VARCHAR},
      </if>
      <if test="depId != null">
        #{depId,jdbcType=INTEGER},
      </if>
      <if test="depName != null">
        #{depName,jdbcType=VARCHAR},
      </if>
      <if test="quoteNo != null">
        #{quoteNo,jdbcType=VARCHAR},
      </if>
      <if test="cstCompanyId != null">
        #{cstCompanyId,jdbcType=INTEGER},
      </if>
      <if test="cstName != null">
        #{cstName,jdbcType=VARCHAR},
      </if>
      <if test="phone != null">
        #{phone,jdbcType=VARCHAR},
      </if>
      <if test="fax != null">
        #{fax,jdbcType=VARCHAR},
      </if>
      <if test="email != null">
        #{email,jdbcType=VARCHAR},
      </if>
      <if test="connectMan != null">
        #{connectMan,jdbcType=VARCHAR},
      </if>
      <if test="salesman != null">
        #{salesman,jdbcType=BIGINT},
      </if>
      <if test="salesmanName != null">
        #{salesmanName,jdbcType=VARCHAR},
      </if>
      <if test="handler != null">
        #{handler,jdbcType=BIGINT},
      </if>
      <if test="handlerName != null">
        #{handlerName,jdbcType=VARCHAR},
      </if>
      <if test="quoteDate != null">
        #{quoteDate,jdbcType=TIMESTAMP},
      </if>
      <if test="availDays != null">
        #{availDays,jdbcType=VARCHAR},
      </if>
      <if test="prodName != null">
        #{prodName,jdbcType=VARCHAR},
      </if>
      <if test="invoiceType != null">
        #{invoiceType,jdbcType=TINYINT},
      </if>
      <if test="invoiceTypeName != null">
        #{invoiceTypeName,jdbcType=VARCHAR},
      </if>
      <if test="taxRatio != null">
        #{taxRatio,jdbcType=DECIMAL},
      </if>
      <if test="quotePrice != null">
        #{quotePrice,jdbcType=DECIMAL},
      </if>
      <if test="quotePriceLocal != null">
        #{quotePriceLocal,jdbcType=DECIMAL},
      </if>
      <if test="coin != null">
        #{coin,jdbcType=VARCHAR},
      </if>
      <if test="coinLocal != null">
        #{coinLocal,jdbcType=VARCHAR},
      </if>
      <if test="deliveryPlace != null">
        #{deliveryPlace,jdbcType=VARCHAR},
      </if>
      <if test="approveStep != null">
        #{approveStep,jdbcType=VARCHAR},
      </if>
      <if test="approveSugg != null">
        #{approveSugg,jdbcType=VARCHAR},
      </if>
      <if test="status != null">
        #{status,jdbcType=TINYINT},
      </if>
      <if test="isActive != null">
        #{isActive,jdbcType=BIT},
      </if>
      <if test="createdAt != null">
        #{createdAt,jdbcType=TIMESTAMP},
      </if>
      <if test="updatedAt != null">
        #{updatedAt,jdbcType=TIMESTAMP},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="com.mt.order.common.model.Quote">
    update quote
    <set>
      <if test="version != null">
        version = #{version,jdbcType=INTEGER},
      </if>
      <if test="companyId != null">
        company_id = #{companyId,jdbcType=INTEGER},
      </if>
      <if test="companyName != null">
        company_name = #{companyName,jdbcType=VARCHAR},
      </if>
      <if test="depId != null">
        dep_id = #{depId,jdbcType=INTEGER},
      </if>
      <if test="depName != null">
        dep_name = #{depName,jdbcType=VARCHAR},
      </if>
      <if test="quoteNo != null">
        quote_no = #{quoteNo,jdbcType=VARCHAR},
      </if>
      <if test="cstCompanyId != null">
        cst_company_id = #{cstCompanyId,jdbcType=INTEGER},
      </if>
      <if test="cstName != null">
        cst_name = #{cstName,jdbcType=VARCHAR},
      </if>
      <if test="phone != null">
        phone = #{phone,jdbcType=VARCHAR},
      </if>
      <if test="fax != null">
        fax = #{fax,jdbcType=VARCHAR},
      </if>
      <if test="email != null">
        email = #{email,jdbcType=VARCHAR},
      </if>
      <if test="connectMan != null">
        connect_man = #{connectMan,jdbcType=VARCHAR},
      </if>
      <if test="salesman != null">
        salesman = #{salesman,jdbcType=BIGINT},
      </if>
      <if test="salesmanName != null">
        salesman_name = #{salesmanName,jdbcType=VARCHAR},
      </if>
      <if test="handler != null">
        handler = #{handler,jdbcType=BIGINT},
      </if>
      <if test="handlerName != null">
        handler_name = #{handlerName,jdbcType=VARCHAR},
      </if>
      <if test="quoteDate != null">
        quote_date = #{quoteDate,jdbcType=TIMESTAMP},
      </if>
      <if test="availDays != null">
        avail_days = #{availDays,jdbcType=VARCHAR},
      </if>
      <if test="prodName != null">
        prod_name = #{prodName,jdbcType=VARCHAR},
      </if>
      <if test="invoiceType != null">
        invoice_type = #{invoiceType,jdbcType=TINYINT},
      </if>
      <if test="invoiceTypeName != null">
        invoice_type_name = #{invoiceTypeName,jdbcType=VARCHAR},
      </if>
      <if test="taxRatio != null">
        tax_ratio = #{taxRatio,jdbcType=DECIMAL},
      </if>
      <if test="quotePrice != null">
        quote_price = #{quotePrice,jdbcType=DECIMAL},
      </if>
      <if test="quotePriceLocal != null">
        quote_price_local = #{quotePriceLocal,jdbcType=DECIMAL},
      </if>
      <if test="coin != null">
        coin = #{coin,jdbcType=VARCHAR},
      </if>
      <if test="coinLocal != null">
        coin_local = #{coinLocal,jdbcType=VARCHAR},
      </if>
      <if test="deliveryPlace != null">
        delivery_place = #{deliveryPlace,jdbcType=VARCHAR},
      </if>
      <if test="approveStep != null">
        approve_step = #{approveStep,jdbcType=VARCHAR},
      </if>
      <if test="approveSugg != null">
        approve_sugg = #{approveSugg,jdbcType=VARCHAR},
      </if>
      <if test="status != null">
        status = #{status,jdbcType=TINYINT},
      </if>
      <if test="isActive != null">
        is_active = #{isActive,jdbcType=BIT},
      </if>
      <if test="createdAt != null">
        created_at = #{createdAt,jdbcType=TIMESTAMP},
      </if>
      <if test="updatedAt != null">
        updated_at = #{updatedAt,jdbcType=TIMESTAMP},
      </if>
    </set>
    where id = #{id,jdbcType=BIGINT}
  </update>
  <update id="updateByPrimaryKey" parameterType="com.mt.order.common.model.Quote">
    update quote
    set version = #{version,jdbcType=INTEGER},
    company_id = #{companyId,jdbcType=INTEGER},
    company_name = #{companyName,jdbcType=VARCHAR},
    dep_id = #{depId,jdbcType=INTEGER},
    dep_name = #{depName,jdbcType=VARCHAR},
    quote_no = #{quoteNo,jdbcType=VARCHAR},
    cst_company_id = #{cstCompanyId,jdbcType=INTEGER},
    cst_name = #{cstName,jdbcType=VARCHAR},
    phone = #{phone,jdbcType=VARCHAR},
    fax = #{fax,jdbcType=VARCHAR},
    email = #{email,jdbcType=VARCHAR},
    connect_man = #{connectMan,jdbcType=VARCHAR},
    salesman = #{salesman,jdbcType=BIGINT},
    salesman_name = #{salesmanName,jdbcType=VARCHAR},
    handler = #{handler,jdbcType=BIGINT},
    handler_name = #{handlerName,jdbcType=VARCHAR},
    quote_date = #{quoteDate,jdbcType=TIMESTAMP},
    avail_days = #{availDays,jdbcType=VARCHAR},
    prod_name = #{prodName,jdbcType=VARCHAR},
    invoice_type = #{invoiceType,jdbcType=TINYINT},
    invoice_type_name = #{invoiceTypeName,jdbcType=VARCHAR},
    tax_ratio = #{taxRatio,jdbcType=DECIMAL},
    quote_price = #{quotePrice,jdbcType=DECIMAL},
    quote_price_local = #{quotePriceLocal,jdbcType=DECIMAL},
    coin = #{coin,jdbcType=VARCHAR},
    coin_local = #{coinLocal,jdbcType=VARCHAR},
    delivery_place = #{deliveryPlace,jdbcType=VARCHAR},
    approve_step = #{approveStep,jdbcType=VARCHAR},
    approve_sugg = #{approveSugg,jdbcType=VARCHAR},
    status = #{status,jdbcType=TINYINT},
    is_active = #{isActive,jdbcType=BIT},
    created_at = #{createdAt,jdbcType=TIMESTAMP},
    updated_at = #{updatedAt,jdbcType=TIMESTAMP}
    where id = #{id,jdbcType=BIGINT}
  </update>



  <!-- 以下为自定义 -->
  <select id="getMaxQuoteIdAndNo" resultType="map">
    SELECT max(id) as id, max(quote_no) as no from quote
  </select>

  <select id="selectByConditions" resultType="map">
    SELECT
      id as quote_id,
      quote_no,
      version,
      cst_company_id,
      cst_name,
      prod_name,
      DATE_FORMAT(quote_date,'%Y-%m-%d') as quote_date,
      salesman,
      salesman_name,
      approve_step
    from quote
    where status = 1
    and company_id = #{companyId}
    <if test="approveStep != null and approveStep.size > 0">
      and approve_step in
      <foreach item="item" index="index" collection="approveStep" open="(" separator="," close=")">
        #{item}
      </foreach>
    </if>
    <if test="cstCompanyId != null and cstCompanyId.size > 0">
      and cst_company_id in
      <foreach item="item" index="index" collection="cstCompanyId" open="(" separator="," close=")">
      #{item}
      </foreach>
    </if>
    <if test="startDate != null and startDate != ''">
      and DATE_FORMAT(quote_date,'%Y-%m-%d') &gt;= #{startDate}
    </if>
    <if test="endDate != null and endDate != ''">
      and DATE_FORMAT(quote_date,'%Y-%m-%d') &lt;= #{endDate}
    </if>
    <if test="prodName != null">
      and ifnull(prod_name,'') like concat(#{prodName}, '%')
    </if>
    <if test="quoteNo != null">
      and ifnull(quote_no, '') like concat(#{quoteNo}, '%')
    </if>
    <if test="salesman != null and salesman.size > 0">
      and salesman in
      <foreach item="item" index="index" collection="salesman" open="(" separator="," close=")">
        #{item}
      </foreach>
    </if>
    ORDER  by quote_no DESC
    limit #{page}, #{pageSize}
  </select>

  <select id="selectByConditionsCount" resultType="java.lang.Long">
    SELECT count(1)
    from quote
    where status = 1
    and company_id = #{companyId}
    <if test="approveStep != null and approveStep.size > 0">
      and approve_step in
      <foreach item="item" index="index" collection="approveStep" open="(" separator="," close=")">
        #{item}
      </foreach>
    </if>
    <if test="cstCompanyId != null and cstCompanyId.size > 0">
      and cst_company_id in
      <foreach item="item" index="index" collection="cstCompanyId" open="(" separator="," close=")">
        #{item}
      </foreach>
    </if>
    <if test="startDate != null and startDate != ''">
      and DATE_FORMAT(quote_date,'%Y-%m-%d') &gt;= #{startDate}
    </if>
    <if test="endDate != null and endDate != ''">
      and DATE_FORMAT(quote_date,'%Y-%m-%d') &lt;= #{endDate}
    </if>
    <if test="prodName != null">
      and ifnull(prod_name,'') like concat(#{prodName}, '%')
    </if>
    <if test="quoteNo != null">
      and ifnull(quote_no, '') like concat(#{quoteNo}, '%')
    </if>
    <if test="salesman != null and salesman.size > 0">
      and salesman in
      <foreach item="item" index="index" collection="salesman" open="(" separator="," close=")">
        #{item}
      </foreach>
    </if>
  </select>

  <!--Alnwick 添加 查找 报价单行信息-->
  <select id="getDetails" resultType="map" parameterType="java.lang.Long">
      select
            id,quote_no, cst_mold_no, material, type, type_name,count, up, price
    FROM quote_mold
    WHERE quote_id = #{quote_id} and status=1
  </select>

  <select id="selectQuoteMoldProd"  resultType="map" parameterType="java.lang.Long">
    SELECT
          cst_prod_name, cst_prod_no, cavity_total, prod_model_pic
         FROM quote_mold_prod
         WHERE  status = 1
          and quote_mold_id = #{id}
  </select>

  <select id="addQuoteLog" resultType="java.lang.String">
    select addQuoteLog(#{quoteId}) from dual
  </select>

  <select id="revertQuoteLog" resultType="java.lang.String">
    select revertQuoteLog(#{quoteId}) from dual
  </select>

  <select id="selectByPrimaryKeyAndVer" resultMap="BaseResultMap">
    select
    <include refid="Base_Column_List" />
    from quote_log
    where  status = 1
    and id = #{quoteId,jdbcType=BIGINT}
    and version = #{version}
  </select>


  <select id="selectHisQuotes" resultType="map">
    SELECT
    id as quote_id,
    quote_no,
    version,
    cst_company_id,
    cst_name,
    prod_name,
    DATE_FORMAT(quote_date,'%Y-%m-%d') as quote_date,
    salesman,
    salesman_name,
    approve_step
    from quote_log
    where status = 1
    and id = #{quoteId}
    ORDER  by version asc
  </select>

<update id="updateQuoteHeadPrice" parameterType="java.lang.Long">
  update quote as a
	INNER JOIN (select min(quote_id) as quote_id, sum(price) as price,sum(price_local) as price_local, sum(rebate_price) as rebate_price from quote_mold where status = 1 and quote_id = #{quote_id}) as b on a.id = b.quote_id
	set a.quote_price = b.price, a.quote_price_local = b.price_local, a.quote_rebate_price = b.rebate_price
	where a.status = 1
	and a.id = #{quote_id}
</update>

</mapper>