<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.mt.iv.common.dao.IvStoreRoomMapper" >
  <resultMap id="BaseResultMap" type="com.mt.iv.common.model.IvStoreRoom" >
    <id column="id" property="id" jdbcType="BIGINT" />
    <result column="store_house_id" property="storeHouseId" jdbcType="BIGINT" />
    <result column="store_room_id" property="storeRoomId" jdbcType="BIGINT" />
    <result column="store_hous_serial_id" property="storeHousSerialId" jdbcType="BIGINT" />
    <result column="mat_id" property="matId" jdbcType="BIGINT" />
    <result column="mat_no" property="matNo" jdbcType="VARCHAR" />
    <result column="mat_desc" property="matDesc" jdbcType="VARCHAR" />
    <result column="mat_type_id" property="matTypeId" jdbcType="BIGINT" />
    <result column="mat_type_name" property="matTypeName" jdbcType="VARCHAR" />
    <result column="mat_model" property="matModel" jdbcType="VARCHAR" />
    <result column="unit" property="unit" jdbcType="VARCHAR" />
    <result column="stock_qty" property="stockQty" jdbcType="DECIMAL" />
    <result column="total_price" property="totalPrice" jdbcType="DECIMAL" />
    <result column="last_handler_id" property="lastHandlerId" jdbcType="BIGINT" />
    <result column="last_handle_time" property="lastHandleTime" jdbcType="TIMESTAMP" />
    <result column="created_at" property="createdAt" jdbcType="TIMESTAMP" />
    <result column="updated_at" property="updatedAt" jdbcType="TIMESTAMP" />
    <result column="status" property="status" jdbcType="TINYINT" />
  </resultMap>
  <sql id="Base_Column_List" >
    id, store_house_id, store_room_id, store_hous_serial_id, mat_id, mat_no, mat_desc, 
    mat_type_id, mat_type_name, mat_model, unit, stock_qty, total_price, last_handler_id, 
    last_handle_time, created_at, updated_at, status
  </sql>
  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Long" >
    select 
    <include refid="Base_Column_List" />
    from iv_store_room
    where id = #{id,jdbcType=BIGINT}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Long" >
    delete from iv_store_room
    where id = #{id,jdbcType=BIGINT}
  </delete>
  <insert id="insert" parameterType="com.mt.iv.common.model.IvStoreRoom" >
    insert into iv_store_room (id, store_house_id, store_room_id, 
      store_hous_serial_id, mat_id, mat_no, 
      mat_desc, mat_type_id, mat_type_name, 
      mat_model, unit, stock_qty, 
      total_price, last_handler_id, last_handle_time, 
      created_at, updated_at, status
      )
    values (#{id,jdbcType=BIGINT}, #{storeHouseId,jdbcType=BIGINT}, #{storeRoomId,jdbcType=BIGINT}, 
      #{storeHousSerialId,jdbcType=BIGINT}, #{matId,jdbcType=BIGINT}, #{matNo,jdbcType=VARCHAR}, 
      #{matDesc,jdbcType=VARCHAR}, #{matTypeId,jdbcType=BIGINT}, #{matTypeName,jdbcType=VARCHAR}, 
      #{matModel,jdbcType=VARCHAR}, #{unit,jdbcType=VARCHAR}, #{stockQty,jdbcType=DECIMAL}, 
      #{totalPrice,jdbcType=DECIMAL}, #{lastHandlerId,jdbcType=BIGINT}, #{lastHandleTime,jdbcType=TIMESTAMP}, 
      #{createdAt,jdbcType=TIMESTAMP}, #{updatedAt,jdbcType=TIMESTAMP}, #{status,jdbcType=TINYINT}
      )
  </insert>
  <insert id="insertSelective" parameterType="com.mt.iv.common.model.IvStoreRoom" >
    insert into iv_store_room
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        id,
      </if>
      <if test="storeHouseId != null" >
        store_house_id,
      </if>
      <if test="storeRoomId != null" >
        store_room_id,
      </if>
      <if test="storeHousSerialId != null" >
        store_hous_serial_id,
      </if>
      <if test="matId != null" >
        mat_id,
      </if>
      <if test="matNo != null" >
        mat_no,
      </if>
      <if test="matDesc != null" >
        mat_desc,
      </if>
      <if test="matTypeId != null" >
        mat_type_id,
      </if>
      <if test="matTypeName != null" >
        mat_type_name,
      </if>
      <if test="matModel != null" >
        mat_model,
      </if>
      <if test="unit != null" >
        unit,
      </if>
      <if test="stockQty != null" >
        stock_qty,
      </if>
      <if test="totalPrice != null" >
        total_price,
      </if>
      <if test="lastHandlerId != null" >
        last_handler_id,
      </if>
      <if test="lastHandleTime != null" >
        last_handle_time,
      </if>
      <if test="createdAt != null" >
        created_at,
      </if>
      <if test="updatedAt != null" >
        updated_at,
      </if>
      <if test="status != null" >
        status,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        #{id,jdbcType=BIGINT},
      </if>
      <if test="storeHouseId != null" >
        #{storeHouseId,jdbcType=BIGINT},
      </if>
      <if test="storeRoomId != null" >
        #{storeRoomId,jdbcType=BIGINT},
      </if>
      <if test="storeHousSerialId != null" >
        #{storeHousSerialId,jdbcType=BIGINT},
      </if>
      <if test="matId != null" >
        #{matId,jdbcType=BIGINT},
      </if>
      <if test="matNo != null" >
        #{matNo,jdbcType=VARCHAR},
      </if>
      <if test="matDesc != null" >
        #{matDesc,jdbcType=VARCHAR},
      </if>
      <if test="matTypeId != null" >
        #{matTypeId,jdbcType=BIGINT},
      </if>
      <if test="matTypeName != null" >
        #{matTypeName,jdbcType=VARCHAR},
      </if>
      <if test="matModel != null" >
        #{matModel,jdbcType=VARCHAR},
      </if>
      <if test="unit != null" >
        #{unit,jdbcType=VARCHAR},
      </if>
      <if test="stockQty != null" >
        #{stockQty,jdbcType=DECIMAL},
      </if>
      <if test="totalPrice != null" >
        #{totalPrice,jdbcType=DECIMAL},
      </if>
      <if test="lastHandlerId != null" >
        #{lastHandlerId,jdbcType=BIGINT},
      </if>
      <if test="lastHandleTime != null" >
        #{lastHandleTime,jdbcType=TIMESTAMP},
      </if>
      <if test="createdAt != null" >
        #{createdAt,jdbcType=TIMESTAMP},
      </if>
      <if test="updatedAt != null" >
        #{updatedAt,jdbcType=TIMESTAMP},
      </if>
      <if test="status != null" >
        #{status,jdbcType=TINYINT},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="com.mt.iv.common.model.IvStoreRoom" >
    update iv_store_room
    <set >
      <if test="storeHouseId != null" >
        store_house_id = #{storeHouseId,jdbcType=BIGINT},
      </if>
      <if test="storeRoomId != null" >
        store_room_id = #{storeRoomId,jdbcType=BIGINT},
      </if>
      <if test="storeHousSerialId != null" >
        store_hous_serial_id = #{storeHousSerialId,jdbcType=BIGINT},
      </if>
      <if test="matId != null" >
        mat_id = #{matId,jdbcType=BIGINT},
      </if>
      <if test="matNo != null" >
        mat_no = #{matNo,jdbcType=VARCHAR},
      </if>
      <if test="matDesc != null" >
        mat_desc = #{matDesc,jdbcType=VARCHAR},
      </if>
      <if test="matTypeId != null" >
        mat_type_id = #{matTypeId,jdbcType=BIGINT},
      </if>
      <if test="matTypeName != null" >
        mat_type_name = #{matTypeName,jdbcType=VARCHAR},
      </if>
      <if test="matModel != null" >
        mat_model = #{matModel,jdbcType=VARCHAR},
      </if>
      <if test="unit != null" >
        unit = #{unit,jdbcType=VARCHAR},
      </if>
      <if test="stockQty != null" >
        stock_qty = #{stockQty,jdbcType=DECIMAL},
      </if>
      <if test="totalPrice != null" >
        total_price = #{totalPrice,jdbcType=DECIMAL},
      </if>
      <if test="lastHandlerId != null" >
        last_handler_id = #{lastHandlerId,jdbcType=BIGINT},
      </if>
      <if test="lastHandleTime != null" >
        last_handle_time = #{lastHandleTime,jdbcType=TIMESTAMP},
      </if>
      <if test="createdAt != null" >
        created_at = #{createdAt,jdbcType=TIMESTAMP},
      </if>
      <if test="updatedAt != null" >
        updated_at = #{updatedAt,jdbcType=TIMESTAMP},
      </if>
      <if test="status != null" >
        status = #{status,jdbcType=TINYINT},
      </if>
    </set>
    where id = #{id,jdbcType=BIGINT}
  </update>
  <update id="updateByPrimaryKey" parameterType="com.mt.iv.common.model.IvStoreRoom" >
    update iv_store_room
    set store_house_id = #{storeHouseId,jdbcType=BIGINT},
      store_room_id = #{storeRoomId,jdbcType=BIGINT},
      store_hous_serial_id = #{storeHousSerialId,jdbcType=BIGINT},
      mat_id = #{matId,jdbcType=BIGINT},
      mat_no = #{matNo,jdbcType=VARCHAR},
      mat_desc = #{matDesc,jdbcType=VARCHAR},
      mat_type_id = #{matTypeId,jdbcType=BIGINT},
      mat_type_name = #{matTypeName,jdbcType=VARCHAR},
      mat_model = #{matModel,jdbcType=VARCHAR},
      unit = #{unit,jdbcType=VARCHAR},
      stock_qty = #{stockQty,jdbcType=DECIMAL},
      total_price = #{totalPrice,jdbcType=DECIMAL},
      last_handler_id = #{lastHandlerId,jdbcType=BIGINT},
      last_handle_time = #{lastHandleTime,jdbcType=TIMESTAMP},
      created_at = #{createdAt,jdbcType=TIMESTAMP},
      updated_at = #{updatedAt,jdbcType=TIMESTAMP},
      status = #{status,jdbcType=TINYINT}
    where id = #{id,jdbcType=BIGINT}
  </update>
  
  
  <!--Alnwick 添加-->



  <select id="selectRommSearchMat" parameterType="map" resultType="map">
    SELECT     a.mat_id,a.mat_no,a.mat_type_id,a.mat_type_name,a.stock_qty,a.id as store_room_id,
                a.total_price,a.unit,a.mat_desc,
                b.store_house_name,a.mat_model,b.store_room_name,
                c.id as store_house_id,c.store_house_name
    FROM       iv_store_room as a ,iv_store_room_conf  as b , iv_store_house_conf as c
    where
              <if test="query.mat_desc != null and query.mat_desc != ''">
                a.mat_desc  REGEXP #{query.mat_desc} and
              </if>
              <if test="query.mat_id != null and query.mat_id != ''">
                a.mat_id  REGEXP #{query.mat_id} and
              </if>
              <if test="query.mat_model != null and query.mat_model != ''">
                a.mat_model  REGEXP #{query.mat_model} and
              </if>
              <if test="query.mat_no != null and query.mat_no != ''">
                a.mat_no  REGEXP #{query.mat_no}    and
              </if>
              <if test="query.store_house_id != null and query.store_house_id != ''">
                a.store_house_id  = #{query.store_house_id}    and
              </if>
              <if test="query.store_room_id != null and query.store_room_id != ''">
                a.store_room_id  = #{query.store_room_id}    and
              </if>
              a.store_room_id = b.id and a.store_house_id=c.id and c.company_id = #{company_id} and  a.status = 1
  </select>


  <update id="updateStoreRoom" parameterType="map" >
      UPDATE iv_store_room_conf
          SET  status = 0
          WHERE id =#{store_room_id}
  </update>

  <update  id="updateStoreRoomMatDesc" parameterType="map">
    update  iv_store_room
     <set >
         <if test="stock_qty != null" >
                stock_qty=#{stock_qty} ,
         </if>
        <if test="total_price != null" >
                total_price=#{total_price},
         </if>
    </set>
    where  mat_id =#{mat_id}
  </update>

  <select  id="selectStoreRoomMatDesc"  resultType="map" parameterType="map" >
    select stock_qty,total_price,mat_id,stock_qty
    from iv_store_room
    where  mat_id=#{mat_id}
            and store_room_id=#{store_room_id}
            and store_house_id=#{store_house_id}
  </select>

  <select  id="selectStoreRoomMatDetail"  resultType="map" parameterType="map" >
    select store_house_id,store_house_name,mat_id,mat_no,mat_desc,mat_type_id,mat_type_name
   ,mat_model,unit,stock_qty as check_bill_qty,total_price as check_bill_price,stock_qty as check_real_qty,
   total_price as check_real_price,store_room_id,store_room_name
    from  iv_store_room
    where  store_house_id=#{store_house_id}
            and  mat_type_id=#{mat_type_id}
  </select>

  <update  id="updateStoreCheckFlag"  parameterType="map">
      update  iv_store_room
      set store_check_flag=1
     <where>
        <if test="store_house_id != null and store_house_id!=''" >
           store_house_id=#{store_house_id}
        </if>
        <if test="mat_type_id != null and mat_type_id!=''" >
          and  mat_type_id=#{mat_type_id}
        </if>
        <if test="store_room_id != null and store_room_id!=''" >
          and store_room_id=#{store_room_id}
        </if>
        <if test="mat_id != null and mat_id!=''" >
          and mat_id=#{mat_id}
        </if>
     </where>
  </update>

  <!--添加库存表-->
  <insert id="addStoreRoom"  parameterType="map" useGeneratedKeys="true" keyProperty="id" keyColumn="id"  >
  <selectKey resultType="int" order="AFTER" keyProperty="id">
    SELECT LAST_INSERT_ID() as id
  </selectKey>
    insert into iv_store_room
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="store_house_id != null" >
        store_house_id,
      </if>
      <if test="store_room_id != null" >
        store_room_id,
      </if>
      <if test="store_house_name != null" >
        store_house_name,
      </if>
      <if test="store_room_name != null" >
        store_room_name,
      </if>
      <if test="mat_id != null" >
        mat_id,
      </if>
      <if test="mat_no != null" >
        mat_no,
      </if>
      <if test="mat_desc != null" >
        mat_desc,
      </if>
      <if test="mat_type_id != null" >
        mat_type_id,
      </if>
      <if test="mat_type_name != null" >
        mat_type_name,
      </if>
      <if test="mat_model != null" >
        mat_model,
      </if>
      <if test="unit != null" >
        unit,
      </if>
      <if test="stock_qty != null  and stock_qty !=''" >
        stock_qty,
      </if>
      <if test="total_price != null and total_price !=''" >
        total_price,
      </if>
      <if test="uid != null" >
        last_handler_id,
      </if>
      <if test="created_at != null" >
        last_handle_time,
      </if>
      <if test="created_at != null" >
        created_at,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="store_house_id != null" >
        #{store_house_id},
      </if>
      <if test="store_room_id != null" >
        #{store_room_id},
      </if>
      <if test="store_house_name != null" >
        #{store_house_name,jdbcType=VARCHAR},
      </if>
      <if test="store_room_name != null" >
        #{store_room_name,jdbcType=VARCHAR},
      </if>
      <if test="mat_id != null" >
        #{mat_id,jdbcType=BIGINT},
      </if>
      <if test="mat_no != null" >
        #{mat_no,jdbcType=VARCHAR},
      </if>
      <if test="mat_desc != null" >
        #{mat_desc,jdbcType=VARCHAR},
      </if>
      <if test="mat_type_id != null" >
        #{mat_type_id,jdbcType=BIGINT},
      </if>
      <if test="mat_type_name != null" >
        #{mat_type_name,jdbcType=VARCHAR},
      </if>
      <if test="mat_model != null" >
        #{mat_model,jdbcType=VARCHAR},
      </if>
      <if test="unit != null" >
        #{unit,jdbcType=VARCHAR},
      </if>
      <if test="stock_qty != null" >
        stock_qty = #{stock_qty,jdbcType=DECIMAL},
      </if>
      <if test="total_price != null" >
        total_price = #{total_price,jdbcType=DECIMAL},
      </if>
      <if test="uid != null" >
        #{uid,jdbcType=BIGINT},
      </if>

      <if test="created_at != null" >
        #{created_at,jdbcType=TIMESTAMP},
      </if>
      <if test="created_at != null" >
        #{created_at,jdbcType=TIMESTAMP},
      </if>
    </trim>
  </insert>

  <!-- 根据库位id查询库位名字 -->
  <select id="selectStoreRoomNameById" parameterType="java.lang.Long" resultType="map">
    select store_room_name from iv_store_room where store_room_id = #{store_room_id} and status = 1
  </select>

</mapper>