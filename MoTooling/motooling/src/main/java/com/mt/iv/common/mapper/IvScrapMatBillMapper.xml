<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.mt.iv.common.dao.IvScrapMatBillMapper" >
  <resultMap id="BaseResultMap" type="com.mt.iv.common.model.IvScrapMatBill" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Nov 30 10:12:04 CST 2017.
    -->
    <id column="id" property="id" jdbcType="BIGINT" />
    <result column="company_id" property="companyId" jdbcType="INTEGER" />
    <result column="company_name" property="companyName" jdbcType="VARCHAR" />
    <result column="scrap_no" property="scrapNo" jdbcType="VARCHAR" />
    <result column="request_date" property="requestDate" jdbcType="TIMESTAMP" />
    <result column="dep_id" property="depId" jdbcType="INTEGER" />
    <result column="dep_name" property="depName" jdbcType="VARCHAR" />
    <result column="creator_id" property="creatorId" jdbcType="VARCHAR" />
    <result column="create_time" property="createTime" jdbcType="TIMESTAMP" />
    <result column="handler_id" property="handlerId" jdbcType="BIGINT" />
    <result column="handle_time" property="handleTime" jdbcType="TIMESTAMP" />
    <result column="approve_step" property="approveStep" jdbcType="VARCHAR" />
    <result column="approve_sugg" property="approveSugg" jdbcType="VARCHAR" />
    <result column="total_qty" property="totalQty" jdbcType="DECIMAL" />
    <result column="total_price" property="totalPrice" jdbcType="DECIMAL" />
    <result column="total_weight" property="totalWeight" jdbcType="DECIMAL" />
    <result column="created_at" property="createdAt" jdbcType="TIMESTAMP" />
    <result column="updated_at" property="updatedAt" jdbcType="TIMESTAMP" />
    <result column="status" property="status" jdbcType="TINYINT" />
  </resultMap>
  <sql id="Base_Column_List" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Nov 30 10:12:04 CST 2017.
    -->
    id, company_id, company_name, scrap_no, request_date, dep_id, dep_name, creator_id, 
    create_time, handler_id, handle_time, approve_step, approve_sugg, total_qty, total_price, 
    total_weight, created_at, updated_at, status
  </sql>
  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Long" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Nov 30 10:12:04 CST 2017.
    -->
    select 
    <include refid="Base_Column_List" />
    from iv_scrap_mat_bill
    where id = #{id,jdbcType=BIGINT}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Long" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Nov 30 10:12:04 CST 2017.
    -->
    delete from iv_scrap_mat_bill
    where id = #{id,jdbcType=BIGINT}
  </delete>
  <insert id="insert" parameterType="com.mt.iv.common.model.IvScrapMatBill" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Nov 30 10:12:04 CST 2017.
    -->
    insert into iv_scrap_mat_bill (id, company_id, company_name, 
      scrap_no, request_date, dep_id, 
      dep_name, creator_id, create_time, 
      handler_id, handle_time, approve_step, 
      approve_sugg, total_qty, total_price, 
      total_weight, created_at, updated_at, 
      status)
    values (#{id,jdbcType=BIGINT}, #{companyId,jdbcType=INTEGER}, #{companyName,jdbcType=VARCHAR}, 
      #{scrapNo,jdbcType=VARCHAR}, #{requestDate,jdbcType=TIMESTAMP}, #{depId,jdbcType=INTEGER}, 
      #{depName,jdbcType=VARCHAR}, #{creatorId,jdbcType=VARCHAR}, #{createTime,jdbcType=TIMESTAMP}, 
      #{handlerId,jdbcType=BIGINT}, #{handleTime,jdbcType=TIMESTAMP}, #{approveStep,jdbcType=VARCHAR}, 
      #{approveSugg,jdbcType=VARCHAR}, #{totalQty,jdbcType=DECIMAL}, #{totalPrice,jdbcType=DECIMAL}, 
      #{totalWeight,jdbcType=DECIMAL}, #{createdAt,jdbcType=TIMESTAMP}, #{updatedAt,jdbcType=TIMESTAMP}, 
      #{status,jdbcType=TINYINT})
  </insert>
  <insert id="insertSelective" parameterType="com.mt.iv.common.model.IvScrapMatBill" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Nov 30 10:12:04 CST 2017.
    -->
    insert into iv_scrap_mat_bill
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        id,
      </if>
      <if test="companyId != null" >
        company_id,
      </if>
      <if test="companyName != null" >
        company_name,
      </if>
      <if test="scrapNo != null" >
        scrap_no,
      </if>
      <if test="requestDate != null" >
        request_date,
      </if>
      <if test="depId != null" >
        dep_id,
      </if>
      <if test="depName != null" >
        dep_name,
      </if>
      <if test="creatorId != null" >
        creator_id,
      </if>
      <if test="createTime != null" >
        create_time,
      </if>
      <if test="handlerId != null" >
        handler_id,
      </if>
      <if test="handleTime != null" >
        handle_time,
      </if>
      <if test="approveStep != null" >
        approve_step,
      </if>
      <if test="approveSugg != null" >
        approve_sugg,
      </if>
      <if test="totalQty != null" >
        total_qty,
      </if>
      <if test="totalPrice != null" >
        total_price,
      </if>
      <if test="totalWeight != null" >
        total_weight,
      </if>
      <if test="createdAt != null" >
        created_at,
      </if>
      <if test="updatedAt != null" >
        updated_at,
      </if>
      <if test="status != null" >
        status,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        #{id,jdbcType=BIGINT},
      </if>
      <if test="companyId != null" >
        #{companyId,jdbcType=INTEGER},
      </if>
      <if test="companyName != null" >
        #{companyName,jdbcType=VARCHAR},
      </if>
      <if test="scrapNo != null" >
        #{scrapNo,jdbcType=VARCHAR},
      </if>
      <if test="requestDate != null" >
        #{requestDate,jdbcType=TIMESTAMP},
      </if>
      <if test="depId != null" >
        #{depId,jdbcType=INTEGER},
      </if>
      <if test="depName != null" >
        #{depName,jdbcType=VARCHAR},
      </if>
      <if test="creatorId != null" >
        #{creatorId,jdbcType=VARCHAR},
      </if>
      <if test="createTime != null" >
        #{createTime,jdbcType=TIMESTAMP},
      </if>
      <if test="handlerId != null" >
        #{handlerId,jdbcType=BIGINT},
      </if>
      <if test="handleTime != null" >
        #{handleTime,jdbcType=TIMESTAMP},
      </if>
      <if test="approveStep != null" >
        #{approveStep,jdbcType=VARCHAR},
      </if>
      <if test="approveSugg != null" >
        #{approveSugg,jdbcType=VARCHAR},
      </if>
      <if test="totalQty != null" >
        #{totalQty,jdbcType=DECIMAL},
      </if>
      <if test="totalPrice != null" >
        #{totalPrice,jdbcType=DECIMAL},
      </if>
      <if test="totalWeight != null" >
        #{totalWeight,jdbcType=DECIMAL},
      </if>
      <if test="createdAt != null" >
        #{createdAt,jdbcType=TIMESTAMP},
      </if>
      <if test="updatedAt != null" >
        #{updatedAt,jdbcType=TIMESTAMP},
      </if>
      <if test="status != null" >
        #{status,jdbcType=TINYINT},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="com.mt.iv.common.model.IvScrapMatBill" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Nov 30 10:12:04 CST 2017.
    -->
    update iv_scrap_mat_bill
    <set >
      <if test="companyId != null" >
        company_id = #{companyId,jdbcType=INTEGER},
      </if>
      <if test="companyName != null" >
        company_name = #{companyName,jdbcType=VARCHAR},
      </if>
      <if test="scrapNo != null" >
        scrap_no = #{scrapNo,jdbcType=VARCHAR},
      </if>
      <if test="requestDate != null" >
        request_date = #{requestDate,jdbcType=TIMESTAMP},
      </if>
      <if test="depId != null" >
        dep_id = #{depId,jdbcType=INTEGER},
      </if>
      <if test="depName != null" >
        dep_name = #{depName,jdbcType=VARCHAR},
      </if>
      <if test="creatorId != null" >
        creator_id = #{creatorId,jdbcType=VARCHAR},
      </if>
      <if test="createTime != null" >
        create_time = #{createTime,jdbcType=TIMESTAMP},
      </if>
      <if test="handlerId != null" >
        handler_id = #{handlerId,jdbcType=BIGINT},
      </if>
      <if test="handleTime != null" >
        handle_time = #{handleTime,jdbcType=TIMESTAMP},
      </if>
      <if test="approveStep != null" >
        approve_step = #{approveStep,jdbcType=VARCHAR},
      </if>
      <if test="approveSugg != null" >
        approve_sugg = #{approveSugg,jdbcType=VARCHAR},
      </if>
      <if test="totalQty != null" >
        total_qty = #{totalQty,jdbcType=DECIMAL},
      </if>
      <if test="totalPrice != null" >
        total_price = #{totalPrice,jdbcType=DECIMAL},
      </if>
      <if test="totalWeight != null" >
        total_weight = #{totalWeight,jdbcType=DECIMAL},
      </if>
      <if test="createdAt != null" >
        created_at = #{createdAt,jdbcType=TIMESTAMP},
      </if>
      <if test="updatedAt != null" >
        updated_at = #{updatedAt,jdbcType=TIMESTAMP},
      </if>
      <if test="status != null" >
        status = #{status,jdbcType=TINYINT},
      </if>
    </set>
    where id = #{id,jdbcType=BIGINT}
  </update>
  <update id="updateByPrimaryKey" parameterType="com.mt.iv.common.model.IvScrapMatBill" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Nov 30 10:12:04 CST 2017.
    -->
    update iv_scrap_mat_bill
    set company_id = #{companyId,jdbcType=INTEGER},
      company_name = #{companyName,jdbcType=VARCHAR},
      scrap_no = #{scrapNo,jdbcType=VARCHAR},
      request_date = #{requestDate,jdbcType=TIMESTAMP},
      dep_id = #{depId,jdbcType=INTEGER},
      dep_name = #{depName,jdbcType=VARCHAR},
      creator_id = #{creatorId,jdbcType=VARCHAR},
      create_time = #{createTime,jdbcType=TIMESTAMP},
      handler_id = #{handlerId,jdbcType=BIGINT},
      handle_time = #{handleTime,jdbcType=TIMESTAMP},
      approve_step = #{approveStep,jdbcType=VARCHAR},
      approve_sugg = #{approveSugg,jdbcType=VARCHAR},
      total_qty = #{totalQty,jdbcType=DECIMAL},
      total_price = #{totalPrice,jdbcType=DECIMAL},
      total_weight = #{totalWeight,jdbcType=DECIMAL},
      created_at = #{createdAt,jdbcType=TIMESTAMP},
      updated_at = #{updatedAt,jdbcType=TIMESTAMP},
      status = #{status,jdbcType=TINYINT}
    where id = #{id,jdbcType=BIGINT}
  </update>


  <!-- wendy添加-->

  <!--查询报废单列表-->
  <select id="selectScrapMatBillList"  resultType="map"  parameterType="map">
    SELECT il.approve_step,
    il.id    AS scrap_id,
    il.scrap_no,
    il.total_qty,
    il.is_scraped,
    Count(*) AS mat_count
    FROM   iv_scrap_mat_bill il
    JOIN iv_scrap_mat_bill_sub ib
    ON ib.scrap_id = il.id
    <where>
      <if test="approve_step != null and approve_step != ''">
        And il.approve_step=#{approve_step}
      </if>
      <if test="company_id != null and company_id != ''">
        And company_id = #{company_id}
      </if>
      And il.status = 1 GROUP BY il.approve_step, il.scrap_no, il.total_qty, il.is_scraped
    </where>
    limit #{page}, #{page_size}
  </select>

  <!--查询报废单列表总条数-->
  <select id="totalCount" parameterType="map" resultType="java.lang.Integer">
    SELECT Count(il.id)
    FROM   iv_scrap_mat_bill il
    INNER JOIN iv_scrap_mat_bill_sub ib
    ON ib.scrap_id = il.id
    <where>
      <if test="approve_step != null and approve_step != ''">
        And il.approve_step=#{approve_step}
      </if>
        And company_id=#{company_id} AND il.status =1
    </where>
  </select>

  <!--查询报废单详情主表-->
  <select  id="selectScrapMatBillDetail"  resultType="map"  parameterType="java.lang.Integer">
       SELECT approve_step, approve_sugg, dep_id, dep_name
      , Date_format(request_date, '%Y-%m-%d') AS request_date, is_scraped
      , id AS scrap_id, scrap_no
  FROM iv_scrap_mat_bill
  WHERE id = #{scrap_id}
      AND status = 1
  </select>

  <!--根据编号查看报废单列表-->
  <select id="selectScrapMatBillById"  resultType="map"  parameterType="java.lang.Long">
      SELECT id AS scrap_id,
         scrap_no
  FROM   iv_scrap_mat_bill
  WHERE  id = #{scrap_id}
         AND status = 1
  </select>

  <!--新增报废单主表-->
  <insert id="addScrapMatBill" parameterType="map" useGeneratedKeys="true" keyProperty="id" keyColumn="id">
    <selectKey resultType="int" order="AFTER" keyProperty="id">
      SELECT LAST_INSERT_ID() as id
    </selectKey>
    insert into iv_scrap_mat_bill
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="company_id != null  and company_id !=''" >
        company_id,
      </if>
      <if test="company_name != null and company_name !=''" >
        company_name,
      </if>
      <if test="scrap_no != null and scrap_no !=''" >
        scrap_no,
      </if>
      <if test="request_date != null and request_date !=''" >
        request_date,
      </if>
      <if test="dep_id != null and dep_id !=''" >
        dep_id,
      </if>
      <if test="dep_name != null and dep_name !=''" >
        dep_name,
      </if>
      <if test="creator_id != null and creator_id !=''" >
        creator_id,
      </if>
      <if test="create_time != null and create_time !=''" >
        create_time,
      </if>
      <if test="handler_id != null and handler_id !=''" >
        handler_id,
      </if>
      <if test="handle_time != null and handle_time !=''" >
        handle_time,
      </if>
      <if test="is_scraped != null and is_scraped !=''" >
        is_scraped,
      </if>
      <if test="approve_step != null and approve_step !=''" >
        approve_step,
      </if>
      <if test="approve_sugg != null and approve_sugg !=''" >
        approve_sugg,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="company_id != null  and company_id !=''" >
        #{company_id,jdbcType=INTEGER},
      </if>
      <if test="company_name != null and company_name !=''" >
        #{company_name,jdbcType=VARCHAR},
      </if>
      <if test="scrap_no != null and scrap_no !=''" >
        #{scrap_no,jdbcType=VARCHAR},
      </if>
      <if test="request_date != null and request_date !=''" >
        #{request_date,jdbcType=TIMESTAMP},
      </if>
      <if test="dep_id != null and dep_id !=''" >
        #{dep_id,jdbcType=INTEGER},
      </if>
      <if test="dep_name != null and dep_name !=''" >
        #{dep_name,jdbcType=VARCHAR},
      </if>
      <if test="creator_id != null and creator_id !=''" >
        #{creator_id,jdbcType=VARCHAR},
      </if>
      <if test="create_time != null and create_time !=''" >
        #{create_time,jdbcType=TIMESTAMP},
      </if>
      <if test="handler_id != null and handler_id !=''" >
        #{handler_id,jdbcType=BIGINT},
      </if>
      <if test="handle_time != null and handle_time !=''" >
        #{handle_time,jdbcType=TIMESTAMP},
      </if>
      <if test="is_scraped != null and is_scraped !=''" >
        #{is_scraped,jdbcType=INTEGER},
      </if>
      <if test="approve_step != null and approve_step !=''" >
        #{approve_step,jdbcType=VARCHAR},
      </if>
      <if test="approve_sugg != null and approve_sugg !=''" >
        #{approve_sugg,jdbcType=VARCHAR},
      </if>
    </trim>
  </insert>

  <!--修改报废单主单-->
  <update  id="updateScrapMatBill"  parameterType="map">
    update iv_scrap_mat_bill
    <set >
      <if test="company_id != null  and company_id !=''" >
        company_id = #{company_id,jdbcType=INTEGER},
      </if>
      <if test="company_name != null and company_name !=''" >
        company_name = #{company_name,jdbcType=VARCHAR},
      </if>
      <if test="scrap_no != null and scrap_no !=''" >
        scrap_no = #{scrap_no,jdbcType=VARCHAR},
      </if>
      <if test="request_date != null and request_date !=''" >
        request_date = #{request_date,jdbcType=TIMESTAMP},
      </if>
      <if test="dep_id != null and dep_id !=''" >
        dep_id = #{dep_id,jdbcType=INTEGER},
      </if>
      <if test="dep_name != null and dep_name !=''" >
        dep_name = #{dep_name,jdbcType=VARCHAR},
      </if>
      <if test="creator_id != null and creator_id !=''" >
        creator_id = #{creator_id,jdbcType=VARCHAR},
      </if>
      <if test="create_time != null and create_time !=''" >
        create_time = #{create_time,jdbcType=TIMESTAMP},
      </if>
      <if test="handler_id != null and handler_id !=''" >
        handler_id = #{handler_id,jdbcType=BIGINT},
      </if>
      <if test="handle_time != null and handle_time !=''" >
        handle_time = #{handle_time,jdbcType=TIMESTAMP},
      </if>
      <if test="is_scraped != null and is_scraped !=''" >
        is_scraped = #{is_scraped,jdbcType=INTEGER},
      </if>
      <if test="approve_step != null and approve_step !=''" >
        approve_step = #{approve_step,jdbcType=VARCHAR},
      </if>
      <if test="approve_sugg != null and approve_sugg !=''" >
        approve_sugg = #{approve_sugg,jdbcType=VARCHAR},
      </if>
    </set>
    where id =#{scrap_id,jdbcType=BIGINT}
  </update>
</mapper>