<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.mt.iv.common.dao.IvApplyMatBillMapper" >
  <resultMap id="BaseResultMap" type="com.mt.iv.common.model.IvApplyMatBill" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sat Nov 25 14:23:59 CST 2017.
    -->
    <id column="id" property="id" jdbcType="BIGINT" />
    <result column="company_id" property="companyId" jdbcType="INTEGER" />
    <result column="company_name" property="companyName" jdbcType="VARCHAR" />
    <result column="apply_no" property="applyNo" jdbcType="VARCHAR" />
    <result column="request_date" property="requestDate" jdbcType="TIMESTAMP" />
    <result column="dep_id" property="depId" jdbcType="INTEGER" />
    <result column="dep_name" property="depName" jdbcType="VARCHAR" />
    <result column="creator_id" property="creatorId" jdbcType="VARCHAR" />
    <result column="create_time" property="createTime" jdbcType="TIMESTAMP" />
    <result column="handler_id" property="handlerId" jdbcType="BIGINT" />
    <result column="handle_time" property="handleTime" jdbcType="TIMESTAMP" />
    <result column="approve_step" property="approveStep" jdbcType="VARCHAR" />
    <result column="approve_sugg" property="approveSugg" jdbcType="VARCHAR" />
    <result column="created_at" property="createdAt" jdbcType="TIMESTAMP" />
    <result column="updated_at" property="updatedAt" jdbcType="TIMESTAMP" />
    <result column="status" property="status" jdbcType="TINYINT" />
  </resultMap>
  <sql id="Base_Column_List" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sat Nov 25 14:23:59 CST 2017.
    -->
    id, company_id, company_name, apply_no, request_date, dep_id, dep_name, creator_id, 
    create_time, handler_id, handle_time, approve_step, approve_sugg, created_at, updated_at, 
    status
  </sql>
  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Long" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sat Nov 25 14:23:59 CST 2017.
    -->
    select 
    <include refid="Base_Column_List" />
    from iv_apply_mat_bill
    where id = #{id,jdbcType=BIGINT}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Long" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sat Nov 25 14:23:59 CST 2017.
    -->
    delete from iv_apply_mat_bill
    where id = #{id,jdbcType=BIGINT}
  </delete>
  <insert id="insert" parameterType="com.mt.iv.common.model.IvApplyMatBill" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sat Nov 25 14:23:59 CST 2017.
    -->
    insert into iv_apply_mat_bill (id, company_id, company_name, 
      apply_no, request_date, dep_id, 
      dep_name, creator_id, create_time, 
      handler_id, handle_time, approve_step, 
      approve_sugg, created_at, updated_at, 
      status)
    values (#{id,jdbcType=BIGINT}, #{companyId,jdbcType=INTEGER}, #{companyName,jdbcType=VARCHAR}, 
      #{applyNo,jdbcType=VARCHAR}, #{requestDate,jdbcType=TIMESTAMP}, #{depId,jdbcType=INTEGER}, 
      #{depName,jdbcType=VARCHAR}, #{creatorId,jdbcType=VARCHAR}, #{createTime,jdbcType=TIMESTAMP}, 
      #{handlerId,jdbcType=BIGINT}, #{handleTime,jdbcType=TIMESTAMP}, #{approveStep,jdbcType=VARCHAR}, 
      #{approveSugg,jdbcType=VARCHAR}, #{createdAt,jdbcType=TIMESTAMP}, #{updatedAt,jdbcType=TIMESTAMP}, 
      #{status,jdbcType=TINYINT})
  </insert>
  <insert id="insertSelective" parameterType="com.mt.iv.common.model.IvApplyMatBill" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sat Nov 25 14:23:59 CST 2017.
    -->
    insert into iv_apply_mat_bill
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        id,
      </if>
      <if test="companyId != null" >
        company_id,
      </if>
      <if test="companyName != null" >
        company_name,
      </if>
      <if test="applyNo != null" >
        apply_no,
      </if>
      <if test="requestDate != null" >
        request_date,
      </if>
      <if test="depId != null" >
        dep_id,
      </if>
      <if test="depName != null" >
        dep_name,
      </if>
      <if test="creatorId != null" >
        creator_id,
      </if>
      <if test="createTime != null" >
        create_time,
      </if>
      <if test="handlerId != null" >
        handler_id,
      </if>
      <if test="handleTime != null" >
        handle_time,
      </if>
      <if test="approveStep != null" >
        approve_step,
      </if>
      <if test="approveSugg != null" >
        approve_sugg,
      </if>
      <if test="createdAt != null" >
        created_at,
      </if>
      <if test="updatedAt != null" >
        updated_at,
      </if>
      <if test="status != null" >
        status,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        #{id,jdbcType=BIGINT},
      </if>
      <if test="companyId != null" >
        #{companyId,jdbcType=INTEGER},
      </if>
      <if test="companyName != null" >
        #{companyName,jdbcType=VARCHAR},
      </if>
      <if test="applyNo != null" >
        #{applyNo,jdbcType=VARCHAR},
      </if>
      <if test="requestDate != null" >
        #{requestDate,jdbcType=TIMESTAMP},
      </if>
      <if test="depId != null" >
        #{depId,jdbcType=INTEGER},
      </if>
      <if test="depName != null" >
        #{depName,jdbcType=VARCHAR},
      </if>
      <if test="creatorId != null" >
        #{creatorId,jdbcType=VARCHAR},
      </if>
      <if test="createTime != null" >
        #{createTime,jdbcType=TIMESTAMP},
      </if>
      <if test="handlerId != null" >
        #{handlerId,jdbcType=BIGINT},
      </if>
      <if test="handleTime != null" >
        #{handleTime,jdbcType=TIMESTAMP},
      </if>
      <if test="approveStep != null" >
        #{approveStep,jdbcType=VARCHAR},
      </if>
      <if test="approveSugg != null" >
        #{approveSugg,jdbcType=VARCHAR},
      </if>
      <if test="createdAt != null" >
        #{createdAt,jdbcType=TIMESTAMP},
      </if>
      <if test="updatedAt != null" >
        #{updatedAt,jdbcType=TIMESTAMP},
      </if>
      <if test="status != null" >
        #{status,jdbcType=TINYINT},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="com.mt.iv.common.model.IvApplyMatBill" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sat Nov 25 14:23:59 CST 2017.
    -->
    update iv_apply_mat_bill
    <set >
      <if test="companyId != null" >
        company_id = #{companyId,jdbcType=INTEGER},
      </if>
      <if test="companyName != null" >
        company_name = #{companyName,jdbcType=VARCHAR},
      </if>
      <if test="applyNo != null" >
        apply_no = #{applyNo,jdbcType=VARCHAR},
      </if>
      <if test="requestDate != null" >
        request_date = #{requestDate,jdbcType=TIMESTAMP},
      </if>
      <if test="depId != null" >
        dep_id = #{depId,jdbcType=INTEGER},
      </if>
      <if test="depName != null" >
        dep_name = #{depName,jdbcType=VARCHAR},
      </if>
      <if test="creatorId != null" >
        creator_id = #{creatorId,jdbcType=VARCHAR},
      </if>
      <if test="createTime != null" >
        create_time = #{createTime,jdbcType=TIMESTAMP},
      </if>
      <if test="handlerId != null" >
        handler_id = #{handlerId,jdbcType=BIGINT},
      </if>
      <if test="handleTime != null" >
        handle_time = #{handleTime,jdbcType=TIMESTAMP},
      </if>
      <if test="approveStep != null" >
        approve_step = #{approveStep,jdbcType=VARCHAR},
      </if>
      <if test="approveSugg != null" >
        approve_sugg = #{approveSugg,jdbcType=VARCHAR},
      </if>
      <if test="createdAt != null" >
        created_at = #{createdAt,jdbcType=TIMESTAMP},
      </if>
      <if test="updatedAt != null" >
        updated_at = #{updatedAt,jdbcType=TIMESTAMP},
      </if>
      <if test="status != null" >
        status = #{status,jdbcType=TINYINT},
      </if>
    </set>
    where id = #{id,jdbcType=BIGINT}
  </update>
  <update id="updateByPrimaryKey" parameterType="com.mt.iv.common.model.IvApplyMatBill" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sat Nov 25 14:23:59 CST 2017.
    -->
    update iv_apply_mat_bill
    set company_id = #{companyId,jdbcType=INTEGER},
      company_name = #{companyName,jdbcType=VARCHAR},
      apply_no = #{applyNo,jdbcType=VARCHAR},
      request_date = #{requestDate,jdbcType=TIMESTAMP},
      dep_id = #{depId,jdbcType=INTEGER},
      dep_name = #{depName,jdbcType=VARCHAR},
      creator_id = #{creatorId,jdbcType=VARCHAR},
      create_time = #{createTime,jdbcType=TIMESTAMP},
      handler_id = #{handlerId,jdbcType=BIGINT},
      handle_time = #{handleTime,jdbcType=TIMESTAMP},
      approve_step = #{approveStep,jdbcType=VARCHAR},
      approve_sugg = #{approveSugg,jdbcType=VARCHAR},
      created_at = #{createdAt,jdbcType=TIMESTAMP},
      updated_at = #{updatedAt,jdbcType=TIMESTAMP},
      status = #{status,jdbcType=TINYINT}
    where id = #{id,jdbcType=BIGINT}
  </update>

<!-- wendy添加-->

  <!--新增领料单主表-->
  <insert id="addApplyMatBill" parameterType="map" useGeneratedKeys="true" keyProperty="id" keyColumn="id">
    <selectKey resultType="int" order="AFTER" keyProperty="id">
      SELECT LAST_INSERT_ID() as id
    </selectKey>
    insert into iv_apply_mat_bill
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="company_id != null and company_id!=''" >
        company_id,
      </if>
      <if test="company_name != null and company_name!=''" >
        company_name,
      </if>
      <if test="apply_no != null and apply_no!=''" >
        apply_no,
      </if>
      <if test="request_date != null and request_date!=''" >
        request_date,
      </if>
      <if test="dep_id != null and dep_id!=''" >
        dep_id,
      </if>
      <if test="dep_name != null and dep_name!=''" >
        dep_name,
      </if>
      <if test="mold_no != null and mold_no!=''" >
        mold_no,
      </if>
      <if test="bom_type != null and bom_type!=''" >
        bom_type,
      </if>
      <if test="aplly_type != null and aplly_type!=''" >
        aplly_type,
      </if>
      <if test="creator_id != null and creator_id!=''" >
        creator_id,
      </if>
      <if test="creator_name != null and creator_name!=''" >
        creator_name,
      </if>
      <if test="create_time != null and create_time!=''" >
        create_time,
      </if>
      <if test="handler_id != null and handler_id!=''" >
        handler_id,
      </if>
      <if test="handle_time != null and handle_time!=''" >
        handle_time,
      </if>
      <if test="approve_step != null and approve_step!=''" >
        approve_step,
      </if>
      <if test="approve_sugg != null and approve_sugg!=''" >
        approve_sugg,
      </if>
      <if test="total_qty != null and total_qty!=''" >
        total_qty,
      </if>
      <if test="total_price != null and total_price!=''" >
        total_price,
      </if>
      <if test="total_weight != null and total_weight!=''" >
        total_weight,
      </if>
      <if test="applied_qty != null and applied_qty!=''" >
        applied_qty,
      </if>
      <if test="created_at != null and created_at!=''" >
        created_at,
      </if>
      <if test="updated_at != null and updated_at!=''" >
        updated_at,
      </if>
      <if test="status != null and status!=''" >
        status,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="company_id != null and company_id!=''" >
        #{company_id,jdbcType=INTEGER},
      </if>
      <if test="company_name != null and company_name!=''" >
        #{company_name,jdbcType=VARCHAR},
      </if>
      <if test="apply_no != null and apply_no!=''" >
        #{apply_no,jdbcType=VARCHAR},
      </if>
      <if test="request_date != null and request_date!=''" >
        #{request_date,jdbcType=TIMESTAMP},
      </if>
      <if test="dep_id != null and dep_id!=''" >
        #{dep_id,jdbcType=INTEGER},
      </if>
      <if test="dep_name != null and dep_name!=''" >
        #{dep_name,jdbcType=VARCHAR},
      </if>
      <if test="mold_no != null and mold_no!=''" >
        #{mold_no,jdbcType=VARCHAR},
      </if>
      <if test="bom_type != null and bom_type!=''" >
        #{bom_type,jdbcType=CHAR},
      </if>
      <if test="aplly_type != null and aplly_type!=''" >
        #{aplly_type,jdbcType=CHAR},
      </if>
      <if test="creator_id != null and creator_id!=''" >
        #{creator_id,jdbcType=BIGINT},
      </if>
      <if test="creator_name != null and creator_name!=''" >
        #{creator_name,jdbcType=VARCHAR},
      </if>
      <if test="create_time != null and create_time!=''" >
        #{create_time,jdbcType=TIMESTAMP},
      </if>
      <if test="handler_id != null and handler_id!=''" >
        #{handler_id,jdbcType=BIGINT},
      </if>
      <if test="handle_time != null and handle_time!=''" >
        #{handle_time,jdbcType=TIMESTAMP},
      </if>
      <if test="approve_step != null and approve_step!=''" >
        #{approve_step,jdbcType=VARCHAR},
      </if>
      <if test="approve_sugg != null and approve_sugg!=''" >
        #{approve_sugg,jdbcType=VARCHAR},
      </if>
      <if test="total_qty != null and total_qty!=''" >
        #{total_qty,jdbcType=DECIMAL},
      </if>
      <if test="total_price != null and total_price!=''" >
        #{total_price,jdbcType=DECIMAL},
      </if>
      <if test="total_weight != null and total_weight!=''" >
        #{total_weight,jdbcType=DECIMAL},
      </if>
      <if test="applied_qty != null and applied_qty!=''" >
        #{applied_qty,jdbcType=DECIMAL},
      </if>
      <if test="created_at != null and created_at!=''" >
        #{created_at,jdbcType=TIMESTAMP},
      </if>
      <if test="updated_at != null and updated_at!=''" >
        #{updated_at,jdbcType=TIMESTAMP},
      </if>
      <if test="status != null and status!=''" >
        #{status,jdbcType=TINYINT},
      </if>
    </trim>
  </insert>

  <!--修改领料主单-->
  <update id="updateApplyMatBill"  parameterType="map">
    update iv_apply_mat_bill
    <set >
      <if test="company_id != null and company_id!=''" >
        company_id = #{company_id,jdbcType=INTEGER},
      </if>
      <if test="company_name != null and company_name!=''" >
        company_name = #{company_name,jdbcType=VARCHAR},
      </if>
      <if test="apply_no != null and apply_no!=''" >
        apply_no = #{apply_no,jdbcType=VARCHAR},
      </if>
      <if test="request_date != null and request_date!=''" >
        request_date = #{request_date,jdbcType=TIMESTAMP},
      </if>
      <if test="dep_id != null and dep_id!=''" >
        dep_id = #{dep_id,jdbcType=INTEGER                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               },
      </if>
      <if test="dep_name != null and dep_name!=''" >
        dep_name = #{dep_name,jdbcType=VARCHAR},
      </if>
      <if test="mold_no != null and mold_no!=''" >
        mold_no = #{mold_no,jdbcType=VARCHAR},
      </if>
      <if test="bom_type != null and bom_type!=''" >
        bom_type = #{bom_type,jdbcType=CHAR},
      </if>
      <if test="aplly_type != null and aplly_type!=''" >
        aplly_type = #{aplly_type,jdbcType=CHAR},
      </if>
      <if test="creator_id != null and creator_id!=''" >
        creator_id = #{creator_id,jdbcType=BIGINT},
      </if>
      <if test="creator_name != null and creator_name!=''" >
        creator_name = #{creator_name,jdbcType=VARCHAR},
      </if>
      <if test="create_time != null and create_time!=''" >
        create_time = #{create_time,jdbcType=TIMESTAMP},
      </if>
      <if test="handler_id != null and handler_id!=''" >
        handler_id = #{handler_id,jdbcType=BIGINT},
      </if>
      <if test="handle_time != null and handle_time!=''" >
        handle_time = #{handle_time,jdbcType=TIMESTAMP},
      </if>
      <if test="approve_step != null and approve_step!=''" >
        approve_step = #{approve_step,jdbcType=VARCHAR},
      </if>
      <if test="approve_sugg != null and approve_sugg!=''" >
        approve_sugg = #{approve_sugg,jdbcType=VARCHAR},
      </if>
      <if test="total_qty != null and total_qty!=''" >
        total_qty = #{total_qty,jdbcType=DECIMAL},
      </if>
      <if test="total_price != null and total_price!=''" >
        total_price = #{total_price,jdbcType=DECIMAL},
      </if>
      <if test="total_weight != null and total_weight!=''" >
        total_weight = #{total_weight,jdbcType=DECIMAL},
      </if>
      <if test="applied_qty != null and applied_qty!=''" >
        applied_qty = #{applied_qty,jdbcType=DECIMAL},
      </if>
      <if test="created_at != null and created_at!=''" >
        created_at = #{created_at,jdbcType=TIMESTAMP},
      </if>
      <if test="updated_at != null and updated_at!=''" >
        updated_at = #{updated_at,jdbcType=TIMESTAMP},
      </if>
      <if test="status != null and status!=''" >
        status = #{status,jdbcType=TINYINT},
      </if>
    </set>
    where id = #{apply_id,jdbcType=BIGINT}
  </update>

  <!--根据领料ID查找信息-->
  <select id="selectApplyMatBillById" resultType="map"  parameterType="java.lang.Long">
     SELECT id AS apply_id, apply_no
  FROM iv_apply_mat_bill
  WHERE id = #{id}
      AND status = 1
  </select>

  <!--根据UID取创建人名称-->
  <select id="selectUserCompanyByUid" resultType="map">
     SELECT work_name
  FROM user_company uy
  WHERE uid = #{creator_id}
      AND company_id = #{company_id}
  LIMIT 1
  </select>

  <!--模具领料——查询BOM物料子表总数量、查询领料子表已领数量-->
  <select id="selectMatInfoByQty"  resultType="map">
     SELECT bne.total_qty, SUM(ib.quantity) AS applyNum
  FROM bm_bom_node bne
      INNER JOIN iv_apply_mat_bill_sub ib ON bne.node_id = ib.node_id
      INNER JOIN iv_apply_mat_bill il ON ib.apply_id = il.id
  WHERE il.aplly_type = 1
      AND bne.node_id = #{node_id}
  </select>

  <!--查询带条件数组领料单列表-->
  <select id="selectApplyMatBillList"  resultType="map"  parameterType="map">
    select id as apply_id,apply_no,approve_step,creator_id,creator_name,dep_id,dep_name,
    DATE_FORMAT(request_date,'%Y-%m-%d') request_date,total_qty,mold_no,bom_type,applied_qty,aplly_type
    from  iv_apply_mat_bill
    <where>
      <if test="approve_step !=null and approve_step.size>0">
        approve_step  IN
        <foreach collection="approve_step" item="list" open="(" separator="," close=")">
          #{list}
        </foreach>
      </if>
      <if test="aplly_type!=null and aplly_type.size>0">
        and  aplly_type  IN
        <foreach collection="aplly_type" item="list" open="(" separator="," close=")">
          #{list}
        </foreach>
      </if>
      <if test="company_id != null and company_id != ''">
      and company_id = #{company_id} and  status = 1  ORDER BY  request_date  desc  limit #{page},#{page_size}
      </if>
    </where>
  </select>

  <select id="totalCount" parameterType="map" resultType="java.lang.Integer">
      SELECT
          count(id)
      FROM iv_apply_mat_bill
    <where>
      <if test="approve_step !=null and approve_step.size>0">
        approve_step  IN
        <foreach collection="approve_step" item="list" open="(" separator="," close=")">
          #{list}
        </foreach>
      </if>
      <if test="aplly_type!=null and aplly_type.size>0">
        and  aplly_type  IN
        <foreach collection="aplly_type" item="list" open="(" separator="," close=")">
          #{list}
        </foreach>
      </if>
      <if test="company_id != null and company_id != ''">
        and company_id = #{company_id} and  status = 1
      </if>
    </where>
  </select>

  <!--查询领料单列表-->
  <select id="selectApplyMatBill" parameterType="java.lang.Integer"  resultType="map">
    select id as apply_id,apply_no,approve_step,approve_sugg,dep_id,dep_name,
    DATE_FORMAT(request_date,'%Y-%m-%d') request_date,aplly_type,applied_qty,bom_type,total_qty,mold_no
    from    iv_apply_mat_bill
    where   id=#{apply_id} and status=1
  </select>

  <select id="selectCompanyId" parameterType="java.lang.Integer"  resultType="map">
     SELECT company_id
  FROM iv_apply_mat_bill
  WHERE id = #{apply_id}
      AND status = 1
  </select>

  <!--判断该领料单信息是否为已审批-审核-审批结束-已领料的状态、如是不能删除-->
  <select id="selectApproveStepList" resultType="map">
      SELECT id, approve_step
  FROM iv_apply_mat_bill
  WHERE id = #{apply_id}
      AND approve_step = 'step10'
  UNION ALL
  SELECT id, approve_step
  FROM iv_apply_mat_bill
  WHERE id = #{apply_id}
      AND approve_step = 'step11'
  </select>

  <!--领料单删除-->
  <update id="updateApplyBill" parameterType="java.lang.Long">
    UPDATE iv_apply_mat_bill
    SET  status = 0
    WHERE id = #{apply_id}
  </update>
</mapper>